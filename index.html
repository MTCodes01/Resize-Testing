<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Time Tracker with Ruler</title>
    <style>
        body {
            margin: 0;
            width: auto;
            height: 100vh;
            background: #000000;
            overflow: auto;
            position: relative;
        }

        .time-ruler {
            position: absolute;
            top: 0;
            left: 50px;
            right: 0;
            width: 100%;
            height: 100vh;
            background: #111;
            border-left: 2px solid #333;
        }

        .time-slot {
            position: absolute;
            left: 0;
            right: 0;
            width: 100%;
            height: calc(100vh / 24);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: #666;
            font-size: 12px;
            font-family: monospace;
        }

        .time-slot:nth-child(even) {
            background: rgba(255, 255, 255, 0.02);
        }

        .time-label {
            position: absolute;
            left: 5px;
            width: 40px;
            text-align: right;
            color: #888;
            font-size: 11px;
            font-family: monospace;
        }

        .section {
            position: absolute;
            left: 100px;
            width: 200px;
            min-height: 30px;
            background: #4a90e2;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            cursor: move;
            user-select: none;
            z-index: 10;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .resize-handle {
            position: absolute;
            width: 90%;
            height: 5px;
            background: rgb(255, 255, 255);
            border-radius: 5px;
            z-index: 11;
            left: 5%;
        }
        
        .top-handle {
            top: -3.5px;
            cursor: n-resize;
        }
        
        .bottom-handle {
            bottom: -3.5px;
            cursor: s-resize;
        }
    </style>
</head>
<body>
    <!-- Time Ruler Background -->
    <div class="time-ruler" id="timeRuler">
        <!-- Time slots will be generated by JavaScript -->
    </div>

    <div class="section" id="section" style="top: 200px;">
        Task 1
        <div class="resize-handle top-handle"></div>
        <div class="resize-handle bottom-handle"></div>
    </div>

    <script>
        let sectionCounter = 1;
        const HOUR_HEIGHT = window.innerHeight / 24;
        const SNAP_THRESHOLD = 10;
        const COLUMN_WIDTH = 220; // Width including margin
        const MIN_LEFT = 100; // Starting position for first column

        // Create time ruler
        function createTimeRuler() {
            const ruler = document.getElementById('timeRuler');
            for (let hour = 0; hour < 24; hour++) {
                const timeSlot = document.createElement('div');
                timeSlot.className = 'time-slot';
                timeSlot.style.top = (hour * HOUR_HEIGHT) + 'px';
                timeSlot.style.height = HOUR_HEIGHT + 'px';
                
                const label = document.createElement('div');
                label.className = 'time-label';
                label.textContent = `${hour.toString().padStart(2, '0')}:00`;
                label.style.top = (hour * HOUR_HEIGHT) + 'px';
                
                ruler.appendChild(timeSlot);
                document.body.appendChild(label);
            }
        }

        // Snap to nearest time slot
        function snapToTimeSlot(yPosition) {
            const hourIndex = Math.round(yPosition / HOUR_HEIGHT);
            return Math.max(0, Math.min(hourIndex * HOUR_HEIGHT, (23 * HOUR_HEIGHT)));
        }

        // Check if position overlaps with existing sections
        function hasOverlap(columnIndex, top, height) {
            const sections = document.querySelectorAll('.section');
            const columnLeft = MIN_LEFT + (columnIndex * COLUMN_WIDTH);
            
            for (let section of sections) {
                const sectionLeft = parseInt(section.style.left);
                const sectionTop = parseInt(section.style.top);
                const sectionHeight = parseInt(section.style.height);
                
                // Check if in same column
                if (Math.abs(sectionLeft - columnLeft) < 10) {
                    // Check vertical overlap
                    if (!(top >= sectionTop + sectionHeight || top + height <= sectionTop)) {
                        return true;
                    }
                }
            }
            return false;
        }

        // Find available column for new section
        function findAvailableColumn(top, height) {
            let columnIndex = 0;
            while (hasOverlap(columnIndex, top, height)) {
                columnIndex++;
            }
            return columnIndex;
        }

        function createSection(x, y) {
            sectionCounter++;
            const snappedTop = snapToTimeSlot(y);
            const defaultHeight = HOUR_HEIGHT;
            
            // Find available column
            const columnIndex = findAvailableColumn(snappedTop, defaultHeight);
            const columnLeft = MIN_LEFT + (columnIndex * COLUMN_WIDTH);
            
            const newSection = document.createElement('div');
            newSection.className = 'section';
            newSection.id = `section${sectionCounter}`;
            newSection.style.left = columnLeft + 'px';
            newSection.style.top = snappedTop + 'px';
            newSection.style.height = defaultHeight + 'px';
            newSection.innerHTML = `
                Task ${sectionCounter}
                <div class="resize-handle top-handle"></div>
                <div class="resize-handle bottom-handle"></div>
            `;
            document.body.appendChild(newSection);
            attachEventListeners(newSection);
        }

        function attachEventListeners(section) {
            const topHandle = section.querySelector(".top-handle");
            const bottomHandle = section.querySelector(".bottom-handle");

            let isDragging = false;
            let isResizingTop = false;
            let isResizingBottom = false;
            let offsetY;
            let initialTop, initialHeight, initialLeft;

            // --- Dragging (vertical only with snapping) ---
            section.addEventListener("mousedown", (e) => {
                if (e.target === topHandle || e.target === bottomHandle) return;
                isDragging = true;
                offsetY = e.clientY - section.offsetTop;
                initialLeft = section.offsetLeft;
                e.stopPropagation();
            });

            // --- Top Resizing ---
            topHandle.addEventListener("mousedown", (e) => {
                isResizingTop = true;
                initialTop = section.offsetTop;
                initialHeight = section.offsetHeight;
                e.stopPropagation();
            });

            // --- Bottom Resizing ---
            bottomHandle.addEventListener("mousedown", (e) => {
                isResizingBottom = true;
                e.stopPropagation();
            });

            document.addEventListener("mousemove", (e) => {
                if (isDragging) {
                    const newTop = e.clientY - offsetY;
                    section.style.top = Math.max(0, Math.min(newTop, window.innerHeight - section.offsetHeight)) + "px";
                } else if (isResizingTop) {
                    const deltaY = e.clientY - initialTop;
                    const newHeight = initialHeight - deltaY;
                    if (newHeight > 20) {
                        const newTop = Math.max(0, e.clientY);
                        section.style.top = newTop + "px";
                        section.style.height = newHeight + "px";
                    }
                } else if (isResizingBottom) {
                    const newHeight = Math.max(20, e.clientY - section.offsetTop);
                    section.style.height = Math.min(newHeight, window.innerHeight - section.offsetTop) + "px";
                }
            });

            document.addEventListener("mouseup", () => {
                if (isDragging) {
                    const snappedTop = snapToTimeSlot(section.offsetTop);
                    
                    // Find current column index
                    const currentColumn = Math.round((initialLeft - MIN_LEFT) / COLUMN_WIDTH);
                    
                    // Check if new position creates overlap in current column
                    section.style.top = snappedTop + 'px';
                    if (hasOverlapExcludingSelf(section, currentColumn, snappedTop, section.offsetHeight)) {
                        // Find new available column
                        const newColumn = findAvailableColumn(snappedTop, section.offsetHeight);
                        section.style.left = (MIN_LEFT + newColumn * COLUMN_WIDTH) + 'px';
                    }
                }
                if (isResizingTop) {
                    section.style.top = snapToTimeSlot(section.offsetTop) + "px";
                }
                if (isResizingBottom) {
                    const currentBottom = section.offsetTop + section.offsetHeight;
                    const snappedBottom = snapToTimeSlot(currentBottom) + HOUR_HEIGHT;
                    section.style.height = Math.max(20, snappedBottom - section.offsetTop) + "px";
                }
                
                isDragging = false;
                isResizingTop = false;
                isResizingBottom = false;
            });
        }

        // Check overlap excluding the section being moved
        function hasOverlapExcludingSelf(excludeSection, columnIndex, top, height) {
            const sections = document.querySelectorAll('.section');
            const columnLeft = MIN_LEFT + (columnIndex * COLUMN_WIDTH);
            
            for (let section of sections) {
                if (section === excludeSection) continue;
                
                const sectionLeft = parseInt(section.style.left);
                const sectionTop = parseInt(section.style.top);
                const sectionHeight = parseInt(section.style.height);
                
                if (Math.abs(sectionLeft - columnLeft) < 10) {
                    if (!(top >= sectionTop + sectionHeight || top + height <= sectionTop)) {
                        return true;
                    }
                }
            }
            return false;
        }

        // Create new section when clicking on time ruler
        document.addEventListener("mousedown", (e) => {
            if (e.target.classList.contains('time-slot') || e.target.classList.contains('time-ruler')) {
                const rect = document.getElementById('timeRuler').getBoundingClientRect();
                createSection(e.clientX - 100, e.clientY);
            }
        });

        // Initialize
        createTimeRuler();
        attachEventListeners(document.getElementById("section"));
    </script>
</body>
</html>
